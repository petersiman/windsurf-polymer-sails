<!doctype html>
<dom-module id="app-main">
  <link rel="stylesheet" href="app-main.css">
  <link rel="import" href="../../elements/menu-panel/menu-panel.html">
  <link rel="import" href="../../elements/login-form/login-form.html">
  <link rel="import" href="../../elements/add-item-form/add-item-form.html">
  <link rel="import" href="../../elements/search-bar/search-bar.html">

  <template>


    <iron-ajax id="advertAjax" url="/advert/list" on-response="handleResponse"></iron-ajax>



      <paper-header-panel condenses keep-condensed-header main>
          <paper-toolbar class="medium">
            <paper-icon-button icon="menu"></paper-icon-button>
            <span class="title">Windsurfing portal</span>
            <paper-search-bar placeholder="Enter search term" nr-selected-filters="[[_getNrSelectedFilters(selectedFilters)]]" on-paper-search-search="loadData" data-dialog="filterDialog" on-paper-search-filter="modalBtnClickHandler"></paper-search-bar>
            <paper-icon-button icon="add" data-dialog="add-item-modal" id="add-item-button" alt="Add new"></paper-icon-button>
            <paper-icon-button icon="account-circle" data-dialog="login-modal" title="Login" id="login-button" alt="Login"></paper-icon-button>
          </paper-toolbar>
          <paper-filter-dialog id="filterDialog" filters="[[filters]]" selected-filters="{{selectedFilters}}" ></paper-filter-dialog>


          <login-form></login-form>

          <add-item-form></add-item-form>
        <search-bar adverts="[[adverts]]"></search-bar>

      </paper-header-panel>
  </template>
  <script>
    Polymer({
      is: "app-main",
      listeners: {
        'login-button.click': 'modalBtnClickHandler',
        'add-item-button.click': 'modalBtnClickHandler'
      },
      modalBtnClickHandler: function(e){
        var button = e.target;
        while (!button.hasAttribute('data-dialog') && button !== document.body) {
          button = button.parentElement;
        }
        if (!button.hasAttribute('data-dialog')) {
          return;
        }
        var id = button.getAttribute('data-dialog');
        var dialog = document.getElementById(id);
        if (dialog) {
          dialog.open();
        }
      },
      loadData : function() {
        // Simulate a 100ms data load
        this.loading = true;
        this.adverts = []
        if (this.$.advertAjax.lastRequest) {
          this.$.advertAjax.lastRequest.abort();
        }

        this.$.advertAjax.generateRequest();
      },
      handleResponse: function(e){
        this.loading = false;
        if (e && e.detail && e.detail.response){
          e.detail.response.forEach(function(item){
            this.hasItems = true;
            this.push('adverts', item);
          }, this);
        }
      },
      _getNrSelectedFilters: function(selectedFilters) {
  			if (Object.keys(selectedFilters).length <= 0) {
  				return 0;
  			}
  			var nrSelectedFilters = Object.keys(selectedFilters)
  				.map(function(key) {
  					// Returns number of selected value for a filter
  					return selectedFilters[key].length;
  				})
  				.reduce(function(sum, value) {
  					// Sum up the selected values across filters
  					return sum + value;
  				});
  			return nrSelectedFilters;
  		},
      properties: {
        adverts: {
         type: Array,
         value: []
       },
        selectedFilters : {
          type: Object,
          value: {
            advertType: [ "buy", "give" ],
            advertCategory: [ "sail" ]
          }
        },
        filters : {
          type: Array,
          value: [
            {
              id: "advertType",
              name: "Advert Type",
              values: [
                {
                  id: "buy",
                  name: "Buy",
                },
                {
                  id: "sell",
                  name: "Sell",
                },
                {
                  id: "give",
                  name: "Give",
                }
              ]
            },
            {
              id: "advertCategory",
              name: "Advert Category",
              values: [
                {
                  id: "sail",
                  name: "Sail"
                },
                {
                  id: "board",
                  name: "Board"
                }
              ]
            }
          ]
        }
      }
    });
  </script>
</dom-module>
